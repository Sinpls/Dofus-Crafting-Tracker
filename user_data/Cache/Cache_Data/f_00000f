import { dataAccessService } from "/services/DataAccessService.ts";
class CalculationService {
  userSetCosts = {};
  calculatedCosts = {};
  intermediateItems = {};
  ingredients = {};
  itemRecipes = {};
  async calculateItemCost(item, amount, depth = 0) {
    const itemName = item.name;
    if (this.userSetCosts[itemName] !== void 0) {
      return this.userSetCosts[itemName] * amount;
    }
    if (this.calculatedCosts[itemName] !== void 0) {
      return this.calculatedCosts[itemName] * amount;
    }
    let totalCost = 0;
    if (item.recipe && item.recipe.length > 0) {
      this.itemRecipes[itemName] = item.recipe;
      for (const ingredient of item.recipe) {
        const ingredientDetails = await dataAccessService.getItemDetails(ingredient.item_ankama_id);
        if (ingredientDetails) {
          const ingredientCost = await this.calculateItemCost(ingredientDetails, ingredient.quantity * amount, depth + 1);
          totalCost += ingredientCost;
          this.updateIngredientOrIntermediate(ingredientDetails, ingredient.quantity * amount, ingredientCost, depth + 1);
        }
      }
    } else {
      totalCost = (this.userSetCosts[itemName] || 0) * amount;
    }
    const costPerUnit = totalCost / amount;
    this.calculatedCosts[itemName] = costPerUnit;
    return totalCost;
  }
  updateIngredientOrIntermediate(item, amount, cost, depth) {
    const itemName = item.name;
    if (item.recipe && item.recipe.length > 0) {
      if (!this.intermediateItems[itemName]) {
        this.intermediateItems[itemName] = {
          name: itemName,
          amount,
          cost: this.userSetCosts[itemName] !== void 0 ? this.userSetCosts[itemName] : cost / amount,
          level: depth,
          isManuallyOverridden: this.userSetCosts[itemName] !== void 0
        };
      } else {
        const existingItem = this.intermediateItems[itemName];
        if (!existingItem.isManuallyOverridden) {
          existingItem.amount += amount;
          existingItem.cost = (existingItem.cost * existingItem.amount + cost) / (existingItem.amount + amount);
        }
        existingItem.level = Math.max(existingItem.level, depth);
      }
    } else {
      if (!this.ingredients[itemName]) {
        this.ingredients[itemName] = {
          name: itemName,
          amount,
          cost: this.userSetCosts[itemName] !== void 0 ? this.userSetCosts[itemName] : cost / amount,
          type: item.type.name,
          isManuallyOverridden: this.userSetCosts[itemName] !== void 0
        };
      } else {
        const existingIngredient = this.ingredients[itemName];
        if (!existingIngredient.isManuallyOverridden) {
          existingIngredient.amount += amount;
          existingIngredient.cost = (existingIngredient.cost * existingIngredient.amount + cost) / (existingIngredient.amount + amount);
        }
      }
    }
  }
  setUserCost(itemName, cost) {
    if (this.intermediateItems[itemName]) {
      const intermediateItem = this.intermediateItems[itemName];
      if (cost !== 0) {
        this.userSetCosts[itemName] = cost;
        intermediateItem.cost = cost;
        intermediateItem.isManuallyOverridden = true;
        this.removeUnusedIngredients(itemName);
      } else {
        delete this.userSetCosts[itemName];
        intermediateItem.isManuallyOverridden = false;
        this.recalculateIntermediateItemCost(itemName);
        this.restoreRecipeIngredients(itemName);
      }
    } else if (this.ingredients[itemName]) {
      this.ingredients[itemName].cost = cost;
      this.ingredients[itemName].isManuallyOverridden = cost !== 0;
      if (cost !== 0) {
        this.userSetCosts[itemName] = cost;
      } else {
        delete this.userSetCosts[itemName];
      }
    }
    delete this.calculatedCosts[itemName];
  }
  recalculateIntermediateItemCost(itemName) {
    const recipe = this.itemRecipes[itemName];
    if (recipe) {
      let totalCost = 0;
      for (const ingredient of recipe) {
        const ingredientCost = this.getIngredientCost(ingredient.name);
        totalCost += ingredientCost * ingredient.quantity;
      }
      this.intermediateItems[itemName].cost = totalCost / this.intermediateItems[itemName].amount;
    }
  }
  getIngredientCost(ingredientName) {
    if (this.userSetCosts[ingredientName] !== void 0) {
      return this.userSetCosts[ingredientName];
    }
    if (this.ingredients[ingredientName]) {
      return this.ingredients[ingredientName].cost;
    }
    if (this.intermediateItems[ingredientName]) {
      return this.intermediateItems[ingredientName].cost;
    }
    return 0;
  }
  removeUnusedIngredients(intermediateItemName) {
    const recipe = this.itemRecipes[intermediateItemName];
    if (recipe) {
      for (const ingredient of recipe) {
        const ingredientName = ingredient.name;
        if (this.ingredients[ingredientName]) {
          this.ingredients[ingredientName].amount -= ingredient.quantity;
          if (this.ingredients[ingredientName].amount <= 0) {
            delete this.ingredients[ingredientName];
          }
        }
      }
    }
  }
  restoreRecipeIngredients(intermediateItemName) {
    const recipe = this.itemRecipes[intermediateItemName];
    if (recipe) {
      for (const ingredient of recipe) {
        const ingredientName = ingredient.name;
        if (this.ingredients[ingredientName]) {
          this.ingredients[ingredientName].amount += ingredient.quantity;
        } else {
          this.ingredients[ingredientName] = {
            name: ingredientName,
            amount: ingredient.quantity,
            cost: 0,
            type: "Resource",
            // Default to Resource, update if needed
            isManuallyOverridden: false
          };
        }
      }
    }
  }
  async calculateCraftedItemCosts(craftedItemList) {
    this.clearCalculations();
    const updatedList = [];
    for (const item of craftedItemList) {
      const itemDetails = await dataAccessService.getItemDetails(item.ankama_id);
      if (itemDetails) {
        const totalCost = await this.calculateItemCost(itemDetails, item.amount);
        const costPerUnit = totalCost / item.amount;
        const totalSell = item.sellPrice * item.amount;
        const profit = totalSell - totalCost;
        updatedList.push({
          ...item,
          costPerUnit: Math.round(costPerUnit),
          profit: Math.round(profit)
        });
        console.log(`Updated ${itemDetails.name}: costPerUnit=${costPerUnit}, profit=${profit}`);
      }
    }
    console.log("Final ingredients:", this.ingredients);
    console.log("Final intermediate items:", this.intermediateItems);
    return updatedList;
  }
  getIntermediateItems() {
    const items = Object.values(this.intermediateItems);
    return items.sort((a, b) => a.level - b.level);
  }
  getIngredients() {
    return Object.values(this.ingredients);
  }
  clearCalculations() {
    this.calculatedCosts = {};
    this.intermediateItems = {};
    this.ingredients = {};
  }
}
export const calculationService = new CalculationService();

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIkNhbGN1bGF0aW9uU2VydmljZS50cyJdLCJzb3VyY2VzQ29udGVudCI6WyIvLyBDYWxjdWxhdGlvblNlcnZpY2UudHNcclxuXHJcbmltcG9ydCB7IGRhdGFBY2Nlc3NTZXJ2aWNlIH0gZnJvbSAnLi9EYXRhQWNjZXNzU2VydmljZSc7XHJcbmltcG9ydCB7IElDcmFmdGVkSXRlbSwgSUluZ3JlZGllbnQsIElJbnRlcm1lZGlhdGVJdGVtLCBJRG9mdXNJdGVtIH0gZnJvbSAnLi4vdHlwZXMnO1xyXG5cclxuY2xhc3MgQ2FsY3VsYXRpb25TZXJ2aWNlIHtcclxuICBwcml2YXRlIHVzZXJTZXRDb3N0czogeyBba2V5OiBzdHJpbmddOiBudW1iZXIgfSA9IHt9O1xyXG4gIHByaXZhdGUgY2FsY3VsYXRlZENvc3RzOiB7IFtrZXk6IHN0cmluZ106IG51bWJlciB9ID0ge307XHJcbiAgcHJpdmF0ZSBpbnRlcm1lZGlhdGVJdGVtczogeyBba2V5OiBzdHJpbmddOiBJSW50ZXJtZWRpYXRlSXRlbSB9ID0ge307XHJcbiAgcHJpdmF0ZSBpbmdyZWRpZW50czogeyBba2V5OiBzdHJpbmddOiBJSW5ncmVkaWVudCB9ID0ge307XHJcbiAgcHJpdmF0ZSBpdGVtUmVjaXBlczogeyBba2V5OiBzdHJpbmddOiBJRG9mdXNJdGVtWydyZWNpcGUnXSB9ID0ge307XHJcblxyXG4gIGFzeW5jIGNhbGN1bGF0ZUl0ZW1Db3N0KGl0ZW06IElEb2Z1c0l0ZW0sIGFtb3VudDogbnVtYmVyLCBkZXB0aDogbnVtYmVyID0gMCk6IFByb21pc2U8bnVtYmVyPiB7XHJcbiAgICBjb25zdCBpdGVtTmFtZSA9IGl0ZW0ubmFtZTtcclxuXHJcbiAgICBpZiAodGhpcy51c2VyU2V0Q29zdHNbaXRlbU5hbWVdICE9PSB1bmRlZmluZWQpIHtcclxuICAgICAgcmV0dXJuIHRoaXMudXNlclNldENvc3RzW2l0ZW1OYW1lXSAqIGFtb3VudDtcclxuICAgIH1cclxuXHJcbiAgICBpZiAodGhpcy5jYWxjdWxhdGVkQ29zdHNbaXRlbU5hbWVdICE9PSB1bmRlZmluZWQpIHtcclxuICAgICAgcmV0dXJuIHRoaXMuY2FsY3VsYXRlZENvc3RzW2l0ZW1OYW1lXSAqIGFtb3VudDtcclxuICAgIH1cclxuXHJcbiAgICBsZXQgdG90YWxDb3N0ID0gMDtcclxuICAgIGlmIChpdGVtLnJlY2lwZSAmJiBpdGVtLnJlY2lwZS5sZW5ndGggPiAwKSB7XHJcbiAgICAgIHRoaXMuaXRlbVJlY2lwZXNbaXRlbU5hbWVdID0gaXRlbS5yZWNpcGU7XHJcbiAgICAgIGZvciAoY29uc3QgaW5ncmVkaWVudCBvZiBpdGVtLnJlY2lwZSkge1xyXG4gICAgICAgIGNvbnN0IGluZ3JlZGllbnREZXRhaWxzID0gYXdhaXQgZGF0YUFjY2Vzc1NlcnZpY2UuZ2V0SXRlbURldGFpbHMoaW5ncmVkaWVudC5pdGVtX2Fua2FtYV9pZCk7XHJcbiAgICAgICAgaWYgKGluZ3JlZGllbnREZXRhaWxzKSB7XHJcbiAgICAgICAgICBjb25zdCBpbmdyZWRpZW50Q29zdCA9IGF3YWl0IHRoaXMuY2FsY3VsYXRlSXRlbUNvc3QoaW5ncmVkaWVudERldGFpbHMsIGluZ3JlZGllbnQucXVhbnRpdHkgKiBhbW91bnQsIGRlcHRoICsgMSk7XHJcbiAgICAgICAgICB0b3RhbENvc3QgKz0gaW5ncmVkaWVudENvc3Q7XHJcblxyXG4gICAgICAgICAgdGhpcy51cGRhdGVJbmdyZWRpZW50T3JJbnRlcm1lZGlhdGUoaW5ncmVkaWVudERldGFpbHMsIGluZ3JlZGllbnQucXVhbnRpdHkgKiBhbW91bnQsIGluZ3JlZGllbnRDb3N0LCBkZXB0aCArIDEpO1xyXG4gICAgICAgIH1cclxuICAgICAgfVxyXG4gICAgfSBlbHNlIHtcclxuICAgICAgdG90YWxDb3N0ID0gKHRoaXMudXNlclNldENvc3RzW2l0ZW1OYW1lXSB8fCAwKSAqIGFtb3VudDtcclxuICAgIH1cclxuXHJcbiAgICBjb25zdCBjb3N0UGVyVW5pdCA9IHRvdGFsQ29zdCAvIGFtb3VudDtcclxuICAgIHRoaXMuY2FsY3VsYXRlZENvc3RzW2l0ZW1OYW1lXSA9IGNvc3RQZXJVbml0O1xyXG4gICAgcmV0dXJuIHRvdGFsQ29zdDtcclxuICB9XHJcblxyXG4gIHByaXZhdGUgdXBkYXRlSW5ncmVkaWVudE9ySW50ZXJtZWRpYXRlKGl0ZW06IElEb2Z1c0l0ZW0sIGFtb3VudDogbnVtYmVyLCBjb3N0OiBudW1iZXIsIGRlcHRoOiBudW1iZXIpIHtcclxuICAgIGNvbnN0IGl0ZW1OYW1lID0gaXRlbS5uYW1lO1xyXG4gICAgaWYgKGl0ZW0ucmVjaXBlICYmIGl0ZW0ucmVjaXBlLmxlbmd0aCA+IDApIHtcclxuICAgICAgLy8gSXQncyBhbiBpbnRlcm1lZGlhdGUgaXRlbVxyXG4gICAgICBpZiAoIXRoaXMuaW50ZXJtZWRpYXRlSXRlbXNbaXRlbU5hbWVdKSB7XHJcbiAgICAgICAgdGhpcy5pbnRlcm1lZGlhdGVJdGVtc1tpdGVtTmFtZV0gPSB7XHJcbiAgICAgICAgICBuYW1lOiBpdGVtTmFtZSxcclxuICAgICAgICAgIGFtb3VudDogYW1vdW50LFxyXG4gICAgICAgICAgY29zdDogdGhpcy51c2VyU2V0Q29zdHNbaXRlbU5hbWVdICE9PSB1bmRlZmluZWQgPyB0aGlzLnVzZXJTZXRDb3N0c1tpdGVtTmFtZV0gOiBjb3N0IC8gYW1vdW50LFxyXG4gICAgICAgICAgbGV2ZWw6IGRlcHRoLFxyXG4gICAgICAgICAgaXNNYW51YWxseU92ZXJyaWRkZW46IHRoaXMudXNlclNldENvc3RzW2l0ZW1OYW1lXSAhPT0gdW5kZWZpbmVkXHJcbiAgICAgICAgfTtcclxuICAgICAgfSBlbHNlIHtcclxuICAgICAgICBjb25zdCBleGlzdGluZ0l0ZW0gPSB0aGlzLmludGVybWVkaWF0ZUl0ZW1zW2l0ZW1OYW1lXTtcclxuICAgICAgICBpZiAoIWV4aXN0aW5nSXRlbS5pc01hbnVhbGx5T3ZlcnJpZGRlbikge1xyXG4gICAgICAgICAgZXhpc3RpbmdJdGVtLmFtb3VudCArPSBhbW91bnQ7XHJcbiAgICAgICAgICBleGlzdGluZ0l0ZW0uY29zdCA9IChleGlzdGluZ0l0ZW0uY29zdCAqIGV4aXN0aW5nSXRlbS5hbW91bnQgKyBjb3N0KSAvIChleGlzdGluZ0l0ZW0uYW1vdW50ICsgYW1vdW50KTtcclxuICAgICAgICB9XHJcbiAgICAgICAgZXhpc3RpbmdJdGVtLmxldmVsID0gTWF0aC5tYXgoZXhpc3RpbmdJdGVtLmxldmVsLCBkZXB0aCk7XHJcbiAgICAgIH1cclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIC8vIEl0J3MgYSBiYXNlIGluZ3JlZGllbnRcclxuICAgICAgaWYgKCF0aGlzLmluZ3JlZGllbnRzW2l0ZW1OYW1lXSkge1xyXG4gICAgICAgIHRoaXMuaW5ncmVkaWVudHNbaXRlbU5hbWVdID0ge1xyXG4gICAgICAgICAgbmFtZTogaXRlbU5hbWUsXHJcbiAgICAgICAgICBhbW91bnQ6IGFtb3VudCxcclxuICAgICAgICAgIGNvc3Q6IHRoaXMudXNlclNldENvc3RzW2l0ZW1OYW1lXSAhPT0gdW5kZWZpbmVkID8gdGhpcy51c2VyU2V0Q29zdHNbaXRlbU5hbWVdIDogY29zdCAvIGFtb3VudCxcclxuICAgICAgICAgIHR5cGU6IGl0ZW0udHlwZS5uYW1lLFxyXG4gICAgICAgICAgaXNNYW51YWxseU92ZXJyaWRkZW46IHRoaXMudXNlclNldENvc3RzW2l0ZW1OYW1lXSAhPT0gdW5kZWZpbmVkXHJcbiAgICAgICAgfTtcclxuICAgICAgfSBlbHNlIHtcclxuICAgICAgICBjb25zdCBleGlzdGluZ0luZ3JlZGllbnQgPSB0aGlzLmluZ3JlZGllbnRzW2l0ZW1OYW1lXTtcclxuICAgICAgICBpZiAoIWV4aXN0aW5nSW5ncmVkaWVudC5pc01hbnVhbGx5T3ZlcnJpZGRlbikge1xyXG4gICAgICAgICAgZXhpc3RpbmdJbmdyZWRpZW50LmFtb3VudCArPSBhbW91bnQ7XHJcbiAgICAgICAgICBleGlzdGluZ0luZ3JlZGllbnQuY29zdCA9IChleGlzdGluZ0luZ3JlZGllbnQuY29zdCAqIGV4aXN0aW5nSW5ncmVkaWVudC5hbW91bnQgKyBjb3N0KSAvIChleGlzdGluZ0luZ3JlZGllbnQuYW1vdW50ICsgYW1vdW50KTtcclxuICAgICAgICB9XHJcbiAgICAgIH1cclxuICAgIH1cclxuICB9XHJcblxyXG4gIHNldFVzZXJDb3N0KGl0ZW1OYW1lOiBzdHJpbmcsIGNvc3Q6IG51bWJlcik6IHZvaWQge1xyXG4gICAgXHJcbiAgICBpZiAodGhpcy5pbnRlcm1lZGlhdGVJdGVtc1tpdGVtTmFtZV0pIHtcclxuICAgICAgY29uc3QgaW50ZXJtZWRpYXRlSXRlbSA9IHRoaXMuaW50ZXJtZWRpYXRlSXRlbXNbaXRlbU5hbWVdO1xyXG4gICAgICBcclxuICAgICAgaWYgKGNvc3QgIT09IDApIHtcclxuICAgICAgICB0aGlzLnVzZXJTZXRDb3N0c1tpdGVtTmFtZV0gPSBjb3N0O1xyXG4gICAgICAgIGludGVybWVkaWF0ZUl0ZW0uY29zdCA9IGNvc3Q7XHJcbiAgICAgICAgaW50ZXJtZWRpYXRlSXRlbS5pc01hbnVhbGx5T3ZlcnJpZGRlbiA9IHRydWU7XHJcbiAgICAgICAgdGhpcy5yZW1vdmVVbnVzZWRJbmdyZWRpZW50cyhpdGVtTmFtZSk7XHJcbiAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgZGVsZXRlIHRoaXMudXNlclNldENvc3RzW2l0ZW1OYW1lXTtcclxuICAgICAgICBpbnRlcm1lZGlhdGVJdGVtLmlzTWFudWFsbHlPdmVycmlkZGVuID0gZmFsc2U7XHJcbiAgICAgICAgdGhpcy5yZWNhbGN1bGF0ZUludGVybWVkaWF0ZUl0ZW1Db3N0KGl0ZW1OYW1lKTtcclxuICAgICAgICB0aGlzLnJlc3RvcmVSZWNpcGVJbmdyZWRpZW50cyhpdGVtTmFtZSk7XHJcbiAgICAgIH1cclxuXHJcbiAgICB9IGVsc2UgaWYgKHRoaXMuaW5ncmVkaWVudHNbaXRlbU5hbWVdKSB7XHJcbiAgICAgIHRoaXMuaW5ncmVkaWVudHNbaXRlbU5hbWVdLmNvc3QgPSBjb3N0O1xyXG4gICAgICB0aGlzLmluZ3JlZGllbnRzW2l0ZW1OYW1lXS5pc01hbnVhbGx5T3ZlcnJpZGRlbiA9IGNvc3QgIT09IDA7XHJcbiAgICAgIGlmIChjb3N0ICE9PSAwKSB7XHJcbiAgICAgICAgdGhpcy51c2VyU2V0Q29zdHNbaXRlbU5hbWVdID0gY29zdDtcclxuICAgICAgfSBlbHNlIHtcclxuICAgICAgICBkZWxldGUgdGhpcy51c2VyU2V0Q29zdHNbaXRlbU5hbWVdO1xyXG4gICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgZGVsZXRlIHRoaXMuY2FsY3VsYXRlZENvc3RzW2l0ZW1OYW1lXTtcclxuICB9XHJcblxyXG4gIHByaXZhdGUgcmVjYWxjdWxhdGVJbnRlcm1lZGlhdGVJdGVtQ29zdChpdGVtTmFtZTogc3RyaW5nKTogdm9pZCB7XHJcbiAgICBjb25zdCByZWNpcGUgPSB0aGlzLml0ZW1SZWNpcGVzW2l0ZW1OYW1lXTtcclxuICAgIGlmIChyZWNpcGUpIHtcclxuICAgICAgbGV0IHRvdGFsQ29zdCA9IDA7XHJcbiAgICAgIGZvciAoY29uc3QgaW5ncmVkaWVudCBvZiByZWNpcGUpIHtcclxuICAgICAgICBjb25zdCBpbmdyZWRpZW50Q29zdCA9IHRoaXMuZ2V0SW5ncmVkaWVudENvc3QoaW5ncmVkaWVudC5uYW1lKTtcclxuICAgICAgICB0b3RhbENvc3QgKz0gaW5ncmVkaWVudENvc3QgKiBpbmdyZWRpZW50LnF1YW50aXR5O1xyXG4gICAgICB9XHJcbiAgICAgIHRoaXMuaW50ZXJtZWRpYXRlSXRlbXNbaXRlbU5hbWVdLmNvc3QgPSB0b3RhbENvc3QgLyB0aGlzLmludGVybWVkaWF0ZUl0ZW1zW2l0ZW1OYW1lXS5hbW91bnQ7XHJcbiAgICB9XHJcbiAgfVxyXG4gIHByaXZhdGUgZ2V0SW5ncmVkaWVudENvc3QoaW5ncmVkaWVudE5hbWU6IHN0cmluZyk6IG51bWJlciB7XHJcbiAgICBpZiAodGhpcy51c2VyU2V0Q29zdHNbaW5ncmVkaWVudE5hbWVdICE9PSB1bmRlZmluZWQpIHtcclxuICAgICAgcmV0dXJuIHRoaXMudXNlclNldENvc3RzW2luZ3JlZGllbnROYW1lXTtcclxuICAgIH1cclxuICAgIGlmICh0aGlzLmluZ3JlZGllbnRzW2luZ3JlZGllbnROYW1lXSkge1xyXG4gICAgICByZXR1cm4gdGhpcy5pbmdyZWRpZW50c1tpbmdyZWRpZW50TmFtZV0uY29zdDtcclxuICAgIH1cclxuICAgIGlmICh0aGlzLmludGVybWVkaWF0ZUl0ZW1zW2luZ3JlZGllbnROYW1lXSkge1xyXG4gICAgICByZXR1cm4gdGhpcy5pbnRlcm1lZGlhdGVJdGVtc1tpbmdyZWRpZW50TmFtZV0uY29zdDtcclxuICAgIH1cclxuICAgIHJldHVybiAwO1xyXG4gIH1cclxuICBwcml2YXRlIHJlbW92ZVVudXNlZEluZ3JlZGllbnRzKGludGVybWVkaWF0ZUl0ZW1OYW1lOiBzdHJpbmcpOiB2b2lkIHtcclxuICAgIGNvbnN0IHJlY2lwZSA9IHRoaXMuaXRlbVJlY2lwZXNbaW50ZXJtZWRpYXRlSXRlbU5hbWVdO1xyXG4gICAgaWYgKHJlY2lwZSkge1xyXG4gICAgICBmb3IgKGNvbnN0IGluZ3JlZGllbnQgb2YgcmVjaXBlKSB7XHJcbiAgICAgICAgY29uc3QgaW5ncmVkaWVudE5hbWUgPSBpbmdyZWRpZW50Lm5hbWU7XHJcbiAgICAgICAgaWYgKHRoaXMuaW5ncmVkaWVudHNbaW5ncmVkaWVudE5hbWVdKSB7XHJcbiAgICAgICAgICB0aGlzLmluZ3JlZGllbnRzW2luZ3JlZGllbnROYW1lXS5hbW91bnQgLT0gaW5ncmVkaWVudC5xdWFudGl0eTtcclxuICAgICAgICAgIGlmICh0aGlzLmluZ3JlZGllbnRzW2luZ3JlZGllbnROYW1lXS5hbW91bnQgPD0gMCkge1xyXG4gICAgICAgICAgICBkZWxldGUgdGhpcy5pbmdyZWRpZW50c1tpbmdyZWRpZW50TmFtZV07XHJcbiAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgICB9XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIHJlc3RvcmVSZWNpcGVJbmdyZWRpZW50cyhpbnRlcm1lZGlhdGVJdGVtTmFtZTogc3RyaW5nKTogdm9pZCB7XHJcbiAgICBjb25zdCByZWNpcGUgPSB0aGlzLml0ZW1SZWNpcGVzW2ludGVybWVkaWF0ZUl0ZW1OYW1lXTtcclxuICAgIGlmIChyZWNpcGUpIHtcclxuICAgICAgZm9yIChjb25zdCBpbmdyZWRpZW50IG9mIHJlY2lwZSkge1xyXG4gICAgICAgIGNvbnN0IGluZ3JlZGllbnROYW1lID0gaW5ncmVkaWVudC5uYW1lO1xyXG4gICAgICAgIGlmICh0aGlzLmluZ3JlZGllbnRzW2luZ3JlZGllbnROYW1lXSkge1xyXG4gICAgICAgICAgdGhpcy5pbmdyZWRpZW50c1tpbmdyZWRpZW50TmFtZV0uYW1vdW50ICs9IGluZ3JlZGllbnQucXVhbnRpdHk7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgIHRoaXMuaW5ncmVkaWVudHNbaW5ncmVkaWVudE5hbWVdID0ge1xyXG4gICAgICAgICAgICBuYW1lOiBpbmdyZWRpZW50TmFtZSxcclxuICAgICAgICAgICAgYW1vdW50OiBpbmdyZWRpZW50LnF1YW50aXR5LFxyXG4gICAgICAgICAgICBjb3N0OiAwLFxyXG4gICAgICAgICAgICB0eXBlOiAnUmVzb3VyY2UnLCAvLyBEZWZhdWx0IHRvIFJlc291cmNlLCB1cGRhdGUgaWYgbmVlZGVkXHJcbiAgICAgICAgICAgIGlzTWFudWFsbHlPdmVycmlkZGVuOiBmYWxzZVxyXG4gICAgICAgICAgfTtcclxuICAgICAgICB9XHJcbiAgICAgIH1cclxuICAgIH1cclxuICB9XHJcblxyXG4gIGFzeW5jIGNhbGN1bGF0ZUNyYWZ0ZWRJdGVtQ29zdHMoY3JhZnRlZEl0ZW1MaXN0OiBJQ3JhZnRlZEl0ZW1bXSk6IFByb21pc2U8SUNyYWZ0ZWRJdGVtW10+IHtcclxuICAgIHRoaXMuY2xlYXJDYWxjdWxhdGlvbnMoKTtcclxuICAgIGNvbnN0IHVwZGF0ZWRMaXN0OiBJQ3JhZnRlZEl0ZW1bXSA9IFtdO1xyXG5cclxuICAgIGZvciAoY29uc3QgaXRlbSBvZiBjcmFmdGVkSXRlbUxpc3QpIHtcclxuICAgICAgY29uc3QgaXRlbURldGFpbHMgPSBhd2FpdCBkYXRhQWNjZXNzU2VydmljZS5nZXRJdGVtRGV0YWlscyhpdGVtLmFua2FtYV9pZCk7XHJcbiAgICAgIGlmIChpdGVtRGV0YWlscykge1xyXG4gICAgICAgIGNvbnN0IHRvdGFsQ29zdCA9IGF3YWl0IHRoaXMuY2FsY3VsYXRlSXRlbUNvc3QoaXRlbURldGFpbHMsIGl0ZW0uYW1vdW50KTtcclxuICAgICAgICBjb25zdCBjb3N0UGVyVW5pdCA9IHRvdGFsQ29zdCAvIGl0ZW0uYW1vdW50O1xyXG4gICAgICAgIGNvbnN0IHRvdGFsU2VsbCA9IGl0ZW0uc2VsbFByaWNlICogaXRlbS5hbW91bnQ7XHJcbiAgICAgICAgY29uc3QgcHJvZml0ID0gdG90YWxTZWxsIC0gdG90YWxDb3N0O1xyXG5cclxuICAgICAgICB1cGRhdGVkTGlzdC5wdXNoKHtcclxuICAgICAgICAgIC4uLml0ZW0sXHJcbiAgICAgICAgICBjb3N0UGVyVW5pdDogTWF0aC5yb3VuZChjb3N0UGVyVW5pdCksXHJcbiAgICAgICAgICBwcm9maXQ6IE1hdGgucm91bmQocHJvZml0KVxyXG4gICAgICAgIH0pO1xyXG4gICAgICAgIGNvbnNvbGUubG9nKGBVcGRhdGVkICR7aXRlbURldGFpbHMubmFtZX06IGNvc3RQZXJVbml0PSR7Y29zdFBlclVuaXR9LCBwcm9maXQ9JHtwcm9maXR9YCk7XHJcbiAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBjb25zb2xlLmxvZyhcIkZpbmFsIGluZ3JlZGllbnRzOlwiLCB0aGlzLmluZ3JlZGllbnRzKTtcclxuICAgIGNvbnNvbGUubG9nKFwiRmluYWwgaW50ZXJtZWRpYXRlIGl0ZW1zOlwiLCB0aGlzLmludGVybWVkaWF0ZUl0ZW1zKTtcclxuICAgIHJldHVybiB1cGRhdGVkTGlzdDtcclxuICB9XHJcblxyXG4gIGdldEludGVybWVkaWF0ZUl0ZW1zKCk6IElJbnRlcm1lZGlhdGVJdGVtW10ge1xyXG4gICAgY29uc3QgaXRlbXMgPSBPYmplY3QudmFsdWVzKHRoaXMuaW50ZXJtZWRpYXRlSXRlbXMpO1xyXG4gICAgcmV0dXJuIGl0ZW1zLnNvcnQoKGEsIGIpID0+IGEubGV2ZWwgLSBiLmxldmVsKTsgIC8vIFNvcnQgYnkgbGV2ZWwgaW4gZGVzY2VuZGluZyBvcmRlclxyXG4gIH1cclxuXHJcbiAgZ2V0SW5ncmVkaWVudHMoKTogSUluZ3JlZGllbnRbXSB7XHJcbiAgICByZXR1cm4gT2JqZWN0LnZhbHVlcyh0aGlzLmluZ3JlZGllbnRzKTtcclxuICB9XHJcblxyXG4gIGNsZWFyQ2FsY3VsYXRpb25zKCk6IHZvaWQge1xyXG4gICAgdGhpcy5jYWxjdWxhdGVkQ29zdHMgPSB7fTtcclxuICAgIHRoaXMuaW50ZXJtZWRpYXRlSXRlbXMgPSB7fTtcclxuICAgIHRoaXMuaW5ncmVkaWVudHMgPSB7fTtcclxuICAgIC8vIE5vdGU6IFdlIGRvbid0IGNsZWFyIHVzZXJTZXRDb3N0cyBhcyB0aGVzZSBzaG91bGQgcGVyc2lzdFxyXG4gIH1cclxufVxyXG5cclxuZXhwb3J0IGNvbnN0IGNhbGN1bGF0aW9uU2VydmljZSA9IG5ldyBDYWxjdWxhdGlvblNlcnZpY2UoKTsiXSwibWFwcGluZ3MiOiJBQUVBLFNBQVMseUJBQXlCO0FBR2xDLE1BQU0sbUJBQW1CO0FBQUEsRUFDZixlQUEwQyxDQUFDO0FBQUEsRUFDM0Msa0JBQTZDLENBQUM7QUFBQSxFQUM5QyxvQkFBMEQsQ0FBQztBQUFBLEVBQzNELGNBQThDLENBQUM7QUFBQSxFQUMvQyxjQUF1RCxDQUFDO0FBQUEsRUFFaEUsTUFBTSxrQkFBa0IsTUFBa0IsUUFBZ0IsUUFBZ0IsR0FBb0I7QUFDNUYsVUFBTSxXQUFXLEtBQUs7QUFFdEIsUUFBSSxLQUFLLGFBQWEsUUFBUSxNQUFNLFFBQVc7QUFDN0MsYUFBTyxLQUFLLGFBQWEsUUFBUSxJQUFJO0FBQUEsSUFDdkM7QUFFQSxRQUFJLEtBQUssZ0JBQWdCLFFBQVEsTUFBTSxRQUFXO0FBQ2hELGFBQU8sS0FBSyxnQkFBZ0IsUUFBUSxJQUFJO0FBQUEsSUFDMUM7QUFFQSxRQUFJLFlB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